<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç›¤é»å°å·¥å…· v2.1.1</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“¦</text></svg>">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0ABAB5">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç›¤é»å°å·¥å…·">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100%25' height='100%25' fill='%230ABAB5'/%3E%3Ctext x='50%25' y='50%25' font-size='70' text-anchor='middle' dominant-baseline='central'%3EğŸ“¦%3C/text%3E%3C/svg%3E">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root { --primary: #0ABAB5; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --blue: #3b82f6; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
        
        /* åŸºç¤è¨­å®šï¼šå¼·åˆ¶æ»¿ç‰ˆ */
        html, body {
            height: 100%;
            margin: 0; padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
        }

        body { 
            box-sizing: border-box;
            padding-top: calc(170px + env(safe-area-inset-top)); 
            padding-bottom: 80px; 
        }
        
        input { user-select: text; }

        /* å›ºå®šå€å®¹å™¨ */
        .fixed-group {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 100;
            background: var(--bg);
        }

        /* 1. Header */
        .header { 
            background: var(--primary); color: white; 
            padding: 15px;
            padding-top: calc(15px + env(safe-area-inset-top));
            display: flex; justify-content: space-between; align-items: center; 
        }
        .header h1 { 
            margin: 0; font-size: 18px; font-weight: 700; 
            display: flex; align-items: center; 
        }
        
        /* ç‰ˆæœ¬è™Ÿæ¨£å¼ */
        .version-badge {
            font-size: 10px;
            background: rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 6px;
            font-weight: 400;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.9);
            margin-top: 4px; 
        }

        .header-tools { display: flex; gap: 10px; }
        .btn-tool { 
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); 
            color: white; padding: 5px 10px; border-radius: 6px; font-size: 12px; 
            cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        .btn-file-wrapper { position: relative; overflow: hidden; }
        .btn-file-wrapper input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* 2. Stats */
        .stats-bar {
            background: var(--bg); padding: 8px 15px; 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .mini-stat {
            background: white; padding: 8px 10px; 
            border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #e5e7eb; cursor: pointer;
        }
        .mini-stat.active { border-color: var(--primary); background: #e0f2f1; }
        .mini-stat-label { font-size: 13px; color: #555; font-weight: 700; } 
        .mini-stat-val { font-size: 20px; font-weight: 800; color: #333; } 

        /* 3. Search */
        .search-container {
            padding: 0 15px 8px 15px; 
            background: var(--bg);
        }
        .search-input { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid #ddd; border-radius: 8px; 
            font-size: 14px; 
            box-sizing: border-box; -webkit-appearance: none; 
            background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* æƒæå€å¡Š (é è¨­éš±è—) */
        .scan-section { padding: 0 10px; margin-bottom: 10px; display: none; }
        .scan-section.show { display: block; }
        
        #reader { 
            width: 96%; height: 270px; 
            background: black; border-radius: 12px; 
            overflow: hidden; position: relative; 
        }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 12px; }

        /* æ‡¸æµ®æŒ‰éˆ• (SVG ç‰ˆæœ¬ + é–å®šä½ç½®) */
        .btn-fab-scan {
            position: fixed !important; 
            bottom: 40px !important;    
            left: 30px !important;      
            
            width: 56px; height: 56px;
            border-radius: 50%; 
            background: var(--text); 
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            border: none;
            
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 9999;
            transition: transform 0.1s;
            
            padding: 0; 
        }

        .btn-fab-scan.active { 
            background: var(--danger); 
            padding: 0;
        }
        
        .btn-fab-scan:active { transform: scale(0.95); }
        .btn-fab-scan svg { display: block; } 

        /* List Styling */
        .item-list { padding: 0 15px; }
        .item-card { background: var(--card); padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #ddd; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .item-card.done { border-left-color: var(--success); }
        .item-card.error { border-left-color: var(--danger); background-color: #fef2f2; }
        .item-card.over { border-left-color: var(--blue); background-color: #eff6ff; } 
        .item-info { flex: 1; padding-right: 10px; min-width: 0; }
        .item-info h3 { margin: 0 0 3px 0; font-size: 15px; line-height: 1.4; }
        .item-info p { margin: 0; font-size: 13px; color: #6b7280; font-family: monospace; } 
        .item-count { text-align: right; display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0; }
        .diff-badge { font-size: 20px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
        .sub-count { font-size: 12px; color: #777; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-weight: 500; }

        /* Modal & Toast */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal { background: white; width: 100%; border-radius: 16px 16px 0 0; padding: 20px; box-sizing: border-box; padding-bottom: 40px; }
        .modal-header { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .modal-code { font-family: monospace; color: #666; font-size: 14px; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 8px 6px; border-radius: 6px; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .stat-label { font-size: 12px; color: #666; font-weight: 500; }
        .stat-val { font-size: 16px; font-weight: bold; color: #333; } 
        .val-rem.ok { color: var(--success); }
        .val-rem.ng { color: var(--danger); }
        .val-rem.over { color: var(--blue); }
        .btn-quick-correct { width: 100%; padding: 10px; background: var(--warning); color: white; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 20px; font-size: 15px; cursor: pointer; }
        .control-group { display: flex; gap: 8px; align-items: center; justify-content: center; margin-bottom: 10px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; border: none; font-size: 22px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #eee; color: #333; padding: 0; padding-bottom: 3px; line-height: 1; }
        .qty-input-main { width: 80px; height: 40px; font-size: 22px; text-align: center; font-weight: bold; border: 2px solid var(--primary); border-radius: 8px; background: #fff; }
        .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-modal { padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; color: white; }
        
        .flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; opacity: 0; transition: opacity 0.2s; }
        
        /* Toast æ¨£å¼ */
        .toast { 
            position: fixed; 
            top: calc(170px + env(safe-area-inset-top) + 210px);
            left: 50%; 
            transform: translateX(-50%); 
            background-color: rgba(0, 0, 0, 0.85); 
            color: white; 
            padding: 12px 24px; 
            border-radius: 30px; 
            font-size: 16px; 
            z-index: 3000; 
            display: none; 
            white-space: nowrap; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            text-align: center;
            width: fit-content; 
            max-width: 90%;
            pointer-events: none; 
        }
    </style>
</head>
<body>

<div id="flashOverlay" class="flash-overlay"></div>

<div class="fixed-group">
    <div class="header">
        <h1>
            ğŸ“¦ ç›¤é»å°å·¥å…· 
            <span class="version-badge">v2.1.1</span>
        </h1>
        <div class="header-tools">
            <label class="btn-tool btn-file-wrapper">
                ğŸ“„ åŒ¯å…¥
                <input type="file" id="fileInput" accept=".xlsx, .xls" onchange="handleFile(this)">
            </label>
            <button type="button" class="btn-tool" onclick="resetAll()">ğŸ”„ é‡ç½®</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="mini-stat active" id="tabAll" onclick="setFilterMode('all')">
            <span class="mini-stat-label">ç¸½å“é …</span>
            <span class="mini-stat-val" id="totalItems">0</span>
        </div>
        <div class="mini-stat" id="tabUnfinished" onclick="setFilterMode('unfinished')">
            <span class="mini-stat-label">æœªç›¤/å·®ç•°</span>
            <span class="mini-stat-val" style="color:var(--danger)" id="unfinishedItems">0</span>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="mainSearchInput" class="search-input" 
               inputmode="numeric" pattern="[0-9]*" enterkeyhint="search" autocomplete="off"
               placeholder="ğŸ” è¼¸å…¥ä»£è™Ÿå¾Œå¹¾ç¢¼..." oninput="filterList(this.value)">
    </div>
</div>

<div class="scan-section" id="scanSection">
    <div id="reader"></div>
</div>

<div class="item-list" id="itemList">
    <div style="text-align:center; color:#999; padding: 40px 20px;">
        è«‹é»æ“Šå³ä¸Šæ–¹ã€ŒğŸ“„åŒ¯å…¥ã€è¼‰å…¥ Excel
    </div>
</div>

<button type="button" class="btn-fab-scan" id="fabScan" onclick="toggleScanner()">
    <svg id="iconCamera" width="30" height="30" viewBox="0 0 24 24" fill="currentColor">
        <path d="M4,7 C2.895,7 2,7.895 2,9 L2,19 C2,20.105 2.895,21 4,21 L20,21 C21.105,21 22,20.105 22,19 L22,9 C22,7.895 21.105,7 20,7 L17,7 L15.586,4.172 C15.211,3.422 14.445,3 13.606,3 L10.394,3 C9.555,3 8.789,3.422 8.414,4.172 L7,7 L4,7 Z M12,18 C9.239,18 7,15.761 7,13 C7,10.239 9.239,8 12,8 C14.761,8 17,10.239 17,13 C17,15.761 14.761,18 12,18 Z"></path>
    </svg>
    
    <svg id="iconStop" style="display:none" width="30" height="30" viewBox="0 0 24 24" fill="currentColor">
        <path d="M5,3 C3.895,3 3,3.895 3,5 L3,19 C3,20.105 3.895,21 5,21 L19,21 C20.105,21 21,20.105 21,19 L21,5 C21,3.895 20.105,3 19,3 L5,3 Z M15.707,8.293 C16.098,8.684 16.098,9.316 15.707,9.707 L13.414,12 L15.707,14.293 C16.098,14.684 16.098,15.316 15.707,15.707 C15.316,16.098 14.684,16.098 14.293,15.707 L12,13.414 L9.707,15.707 C9.316,16.098 8.684,16.098 8.293,15.707 C7.902,15.316 7.902,14.684 8.293,14.293 L10.586,12 L8.293,9.707 C7.902,9.316 7.902,8.684 8.293,8.293 C8.684,7.902 9.316,7.902 9.707,8.293 L12,10.586 L14.293,8.293 C14.684,7.902 15.316,7.902 15.707,8.293 Z"></path>
    </svg>
</button>

<div id="toast" class="toast"></div>

<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modalName">å•†å“åç¨±</div>
            <span class="modal-code" id="modalCode">CODE123</span>
        </div>
        <div class="stats-grid">
            <div class="stat-box">
                <span class="stat-label">æ‡‰æœ‰</span>
                <span class="stat-val" id="modalSys">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">å·²ç›¤</span>
                <span class="stat-val" id="modalAct">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">æœªç›¤</span>
                <span class="stat-val val-rem" id="modalRem">0</span>
            </div>
        </div>
        <button type="button" class="btn-quick-correct" onclick="quickCorrect()">
            âš¡ ä¸€éµæ­£ç¢º (<span id="btnQuickQty"></span>å€‹)
        </button>
        <div class="control-group">
            <button type="button" class="btn-circle" onclick="adjustQty(-1)">-</button>
            <input type="number" id="modalQty" class="qty-input-main" value="0" 
                   inputmode="numeric" pattern="[0-9]*" enterkeyhint="done" autocomplete="off"
                   onclick="this.select()" oninput="syncInputToStats()">
            <button type="button" class="btn-circle" onclick="adjustQty(1)">+</button>
        </div>
        <div class="modal-btns">
            <button type="button" class="btn-modal" style="background: #9ca3af;" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn-modal" style="background: var(--primary);" onclick="saveQty()">å„²å­˜</button>
        </div>
    </div>
</div>

<script>
    let inventoryData = [];
    let html5QrCode;
    let isScanning = false;
    let lastScannedCode = "";
    let lastScanTime = 0;
    let currentEditIndex = -1;
    let filterMode = 'all';

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const SYSTEM_COLUMNS = { code: ['ç”¢å“ä»£è™Ÿ'], name: ['ç”¢å“åç¨±'], qty:  ['åˆ†å€‰å­˜é‡'] };

    function getValue(row, possibleNames) {
        for (let name of possibleNames) { if (row[name] !== undefined) return row[name]; }
        return null;
    }

    function playBeep(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        if (type === 'success') {
            oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.1);
        } else {
            oscillator.type = 'sawtooth'; oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.3);
        }
    }

    function triggerFlash(color) {
        const overlay = document.getElementById('flashOverlay');
        overlay.style.backgroundColor = color === 'success' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)';
        overlay.style.opacity = 1; setTimeout(() => { overlay.style.opacity = 0; }, 300);
    }

    function handleFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);
                if (json.length === 0) { alert("âŒ ç©ºç™½æª”æ¡ˆ"); return; }
                const firstRow = json[0];
                const hasCode = getValue(firstRow, SYSTEM_COLUMNS.code) !== null;
                const hasName = getValue(firstRow, SYSTEM_COLUMNS.name) !== null;
                if (!hasCode && !hasName) { alert("âŒ æ ¼å¼éŒ¯èª¤"); input.value = ''; return; }
                inventoryData = json.map(row => {
                    const rawCode = getValue(row, SYSTEM_COLUMNS.code);
                    const rawName = getValue(row, SYSTEM_COLUMNS.name);
                    const rawQty  = getValue(row, SYSTEM_COLUMNS.qty);
                    return {
                        code: rawCode ? String(rawCode).trim() : '', 
                        name: rawName ? String(rawName).trim() : 'æœªå‘½å',
                        sysQty: rawQty ? Math.floor(Number(rawQty)) : 0,
                        actQty: 0, counted: false 
                    };
                }).filter(item => item.code !== '');
                setFilterMode('all');
                
                alert(`âœ… å·²è¼‰å…¥ ${inventoryData.length} ç­†è³‡æ–™`);
                
            } catch(err) { alert("âŒ è®€å–å¤±æ•—"); }
        };
        reader.readAsArrayBuffer(file); input.value = ''; 
    }

    function renderList(filterText = '') {
        const container = document.getElementById('itemList');
        container.innerHTML = '';
        if (inventoryData.length === 0) {
             container.innerHTML = `<div style="text-align:center; color:#999; padding: 40px 20px;">è«‹é»æ“Šå³ä¸Šæ–¹ã€ŒğŸ“„åŒ¯å…¥ã€è¼‰å…¥ Excel</div>`;
             return;
        }
        let filtered = inventoryData.filter(item => 
            item.code.toLowerCase().includes(filterText.toLowerCase()) || 
            item.name.toLowerCase().includes(filterText.toLowerCase())
        );
        if (filterMode === 'unfinished') {
            filtered = filtered.filter(item => !(item.counted && item.actQty === item.sysQty));
        }
        if (filtered.length === 0) {
            if (filterText.trim() !== '') {
                container.innerHTML = `<div style="text-align:center; color:#999; padding: 20px;">ğŸ” ç„¡ç¬¦åˆé …ç›®</div>`;
            } else if (filterMode === 'unfinished') {
                container.innerHTML = `<div style="text-align:center; color:var(--success); padding: 40px 20px; font-weight:bold; font-size:18px;">
                    ğŸ‰ æ­å–œï¼å·²ç›¤é»å®Œå…¨éƒ¨é …ç›®ï¼
                </div>`;
            } else {
                container.innerHTML = `<div style="text-align:center; color:#999; padding: 20px;">ç„¡ç¬¦åˆé …ç›®</div>`;
            }
            return;
        }
        filtered.forEach((item) => {
            const realIndex = inventoryData.indexOf(item);
            let statusClass = 'todo';
            const remaining = item.sysQty - item.actQty;
            let remColor = 'var(--danger)';
            if (item.counted) {
                if (remaining === 0) { statusClass = 'done'; remColor = 'var(--success)'; }
                else if (remaining < 0) { statusClass = 'over'; remColor = 'var(--blue)'; }
                else { statusClass = 'error'; }
            }
            const div = document.createElement('div');
            div.className = `item-card ${statusClass}`;
            div.onclick = () => openEditModal(realIndex);
            div.innerHTML = `
                <div class="item-info">
                    <h3>${item.name}</h3>
                    <p>${item.code}</p>
                </div>
                <div class="item-count">
                    <span class="diff-badge" style="color:${remColor}">${remaining}</span>
                    <span class="sub-count">å·² ${item.actQty} / æ‡‰ ${item.sysQty}</span>
                </div>`;
            container.appendChild(div);
        });
        updateStats();
    }

    function updateStats() {
        const total = inventoryData.length;
        const unfinished = inventoryData.filter(item => !(item.counted && item.actQty === item.sysQty)).length;
        document.getElementById('totalItems').innerText = total;
        document.getElementById('unfinishedItems').innerText = unfinished;
    }

    function setFilterMode(mode) {
        filterMode = mode;
        document.getElementById('tabAll').className = mode === 'all' ? 'mini-stat active' : 'mini-stat';
        document.getElementById('tabUnfinished').className = mode === 'unfinished' ? 'mini-stat active' : 'mini-stat';
        renderList(document.getElementById('mainSearchInput').value);
    }

    function openEditModal(index) {
        if(isScanning && html5QrCode) {
            html5QrCode.pause();
        }
        currentEditIndex = index;
        const item = inventoryData[index];
        document.getElementById('modalName').innerText = item.name;
        document.getElementById('modalCode').innerText = item.code;
        document.getElementById('modalSys').innerText = item.sysQty;
        document.getElementById('btnQuickQty').innerText = item.sysQty;
        const currentAct = item.counted ? item.actQty : 0;
        document.getElementById('modalQty').value = currentAct;
        syncInputToStats(); 
        
        document.getElementById('fabScan').style.display = 'none';
        
        document.getElementById('editModal').style.display = 'flex';
    }

    function syncInputToStats() {
        if (currentEditIndex === -1) return;
        const item = inventoryData[currentEditIndex];
        const currentInput = Number(document.getElementById('modalQty').value);
        document.getElementById('modalAct').innerText = currentInput;
        const rem = item.sysQty - currentInput;
        const remEl = document.getElementById('modalRem');
        remEl.innerText = rem;
        remEl.className = 'stat-val val-rem'; 
        if(rem === 0) remEl.classList.add('ok');
        else if (rem < 0) remEl.classList.add('over');
        else remEl.classList.add('ng');
    }

    function adjustQty(delta) {
        const input = document.getElementById('modalQty');
        let val = Number(input.value) + delta;
        if(val < 0) val = 0;
        input.value = val;
        syncInputToStats();
    }

    function quickCorrect() {
        if (currentEditIndex === -1) return;
        const item = inventoryData[currentEditIndex];
        document.getElementById('modalQty').value = item.sysQty;
        saveQty(); 
    }

    function saveQty() {
        if (currentEditIndex === -1) return;
        const qty = Number(document.getElementById('modalQty').value);
        inventoryData[currentEditIndex].actQty = qty;
        inventoryData[currentEditIndex].counted = true;
        
        if (document.activeElement) { document.activeElement.blur(); }
        closeModal();
        
        document.getElementById('mainSearchInput').value = '';
        renderList(''); 
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
        document.getElementById('fabScan').style.display = 'flex';
        currentEditIndex = -1;
        if(isScanning && html5QrCode) html5QrCode.resume();
    }

    // ğŸ‘‡ ä¿®æ­£å¾Œçš„ç›¸æ©Ÿå•Ÿå‹•å‡½å¼ (å¯¬å®¹æ¨¡å¼)
    async function toggleScanner() {
        const btn = document.getElementById('fabScan');
        const iconCamera = document.getElementById('iconCamera');
        const iconStop = document.getElementById('iconStop');
        
        const readerDiv = document.getElementById('reader');
        const section = document.getElementById('scanSection');
        
        if (isScanning) {
            try { if (html5QrCode) { await html5QrCode.stop(); html5QrCode.clear(); } } catch(e) {}
            section.classList.remove('show');
            readerDiv.style.display = 'none';
            btn.classList.remove('active');
            
            iconCamera.style.display = 'block';
            iconStop.style.display = 'none';
            
            isScanning = false;
        } else {
            section.classList.add('show');
            readerDiv.style.display = 'block';
            btn.classList.add('active');
            
            iconCamera.style.display = 'none';
            iconStop.style.display = 'block';
            
            html5QrCode = new Html5Qrcode("reader");
            
            // ğŸ‘‡ é€™è£¡çš„åƒæ•¸å·²æ”¾å¯¬ï¼Œåªè¦æ±‚ã€Œç†æƒ³å€¼ã€è€Œä¸å¼·åˆ¶ã€Œæœ€å°å€¼ã€
            const constraints = { 
                facingMode: "environment",
                width: { ideal: 1280, max: 1920 }, // è©¦è‘—æŠ“é«˜æ¸…ï¼Œä½†ä¸è¡Œå°±ç®—äº†
                height: { ideal: 720, max: 1080 } 
            };

            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 120 },
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                }
            };
            
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            html5QrCode.start(constraints, config, onScanSuccess).catch(err => {
                // å¦‚æœç¬¬ä¸€æ¬¡å¤±æ•—ï¼Œå˜—è©¦ç”¨æœ€åŸºæœ¬æ¨¡å¼å†å•Ÿå‹•ä¸€æ¬¡
                console.warn("High-res failed, retrying with basic config...", err);
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess).catch(err2 => {
                    alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™æˆ–ä½¿ç”¨ Chrome/Safari ç€è¦½å™¨");
                    toggleScanner();
                });
            });
            
            isScanning = true;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        const now = Date.now();
        if (decodedText === lastScannedCode && now - lastScanTime < 1000) return;
        lastScannedCode = decodedText;
        lastScanTime = now;
        const item = inventoryData.find(i => i.code === decodedText);
        if (item) {
            item.actQty++;
            item.counted = true;
            playBeep('success');
            triggerFlash('success');
            
            showToast(`ã€${item.code}ã€‘+1 (${item.actQty}/${item.sysQty})`);
            
            updateStats();
            renderList(document.getElementById('mainSearchInput').value);
        } else {
            playBeep('error');
            triggerFlash('error');
            showToast(`âŒ æœªçŸ¥ä»£è™Ÿï¼š${decodedText}`);
        }
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1500);
    }
    
    function filterList(val) { renderList(val); }
    function resetAll() { if(confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ')) { inventoryData = []; renderList(); updateStats(); } }
</script>
</body>
</html>
